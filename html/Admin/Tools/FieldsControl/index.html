<& /Admin/Elements/Header, Title => $title &>
<& /Elements/Tabs &>

<& /Elements/ListActions, actions => \@results &>

<& Elements/CollectionTable, headers => $table_headers, rows => $table_rows &>

<%init>
my $title = loc('FieldsControl configuration');
unless ($session{'CurrentUser'}->HasRight( Object=> $RT::System, Right => 'SuperUser')) {
    Abort(loc('This feature is only available to system administrators'));
}

use Data::Dumper qw(Dumper);

my %config = RT::Extension::FieldsControl::load_config;
my $restrictions = $config{restrictions};
my @results;

# Fill data for CollectionTable
my $table_rows = [];
my $table_headers = [loc('#'), loc('Name'), loc('"Fails if" section fields'), loc('Status')];

foreach my $id (sort keys %$restrictions) {
    push @$table_rows, {
        'link' => '/Admin/Tools/FieldsControl/edit.html?id=' . $id,
        'cols' => [
            $id,
            $restrictions->{$id}->{'rulename'},
            (join ', ', map {loc($_->{'field'})} @{$restrictions->{$id}->{'rfields'}}),
            ($restrictions->{$id}->{'enabled'} ? loc('Enabled') : loc('Disabled')) #loc
        ],
    };
}
</%init>
